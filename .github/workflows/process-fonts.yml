name: Process Fonts

on:
  repository_dispatch:
    types: [process-fonts]
  workflow_dispatch:  # 允许手动触发

jobs:
  process-fonts:
    runs-on: ubuntu-latest
    # 在job级别添加权限，允许写入内容（推送代码）
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # 添加token配置 ⭐
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y woff2

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download update info
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: check-updates.yml
          name: update-info
          path: data/
          search_artifacts: true
          workflow_conclusion: success
        continue-on-error: true

      - name: Create update info if not exists
        run: |
          if [ ! -f data/updates.json ]; then
            echo "Creating empty updates file for manual run..."
            mkdir -p data
            echo '[]' > data/updates.json
          fi

      - name: Process fonts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/process_fonts.py \
            --config config/fonts.json \
            --ranges config/unicode_ranges.json \
            --updates data/updates.json \
            --output fonts \
            --versions data/versions.json

      - name: Generate font list
        run: |
          python scripts/generate_font_list.py \
            --fonts-dir fonts \
            --output fonts/index.json

      - name: Commit processed fonts
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add fonts/
          git add data/versions.json

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update processed fonts [skip ci]"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
          fi

      - name: Get version info
        id: version
        run: |
          # 获取最新的release标签
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -n "$LATEST_TAG" ]; then
            # 从标签中提取版本号（假设格式为 v0.1.0）
            BASE_VERSION=$(echo "$LATEST_TAG" | sed 's/^v//')
            MAJOR=$(echo "$BASE_VERSION" | cut -d. -f1)
            MINOR=$(echo "$BASE_VERSION" | cut -d. -f2)
            PATCH=$(echo "$BASE_VERSION" | cut -d. -f3)
            NEW_PATCH=$((PATCH + 1))
            VERSION="v${MAJOR}.${MINOR}.${NEW_PATCH}"
          else
            # 没有标签，从0.1.0开始
            VERSION="v0.1.0"
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Fonts Release ${{ steps.version.outputs.version }}
          body: |
            ## 字体更新

            本次发布包含以下字体的子集化版本：

            - 查看 `fonts/` 目录获取所有字体文件
            - 查看 `fonts/index.json` 获取字体列表

            ### 使用方法

            通过 jsDelivr CDN 引用：

            ```css
            @font-face {
              font-family: 'FontName';
              src: url('https://cdn.jsdelivr.net/gh/${{ github.repository }}@fonts-${{ steps.version.outputs.version }}/fonts/FontName/FontName-Regular-0.woff2') format('woff2');
              unicode-range: U+0-FF;
            }
            ```

            或使用最新版本：

            ```css
            @font-face {
              font-family: 'FontName';
              src: url('https://cdn.jsdelivr.net/gh/${{ github.repository }}@latest/fonts/FontName/FontName-Regular-0.woff2') format('woff2');
              unicode-range: U+0-FF;
            }
            ```
          files: |
            fonts/**/*.woff2
            fonts/**/*.css
            fonts/index.json
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
